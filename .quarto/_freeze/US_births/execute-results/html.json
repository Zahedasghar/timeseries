{
  "hash": "b77072daac58cb886c433af14ced570e",
  "result": {
    "engine": "knitr",
    "markdown": "\n\n## https://visualizingsociety.com/slides/08-slides.pdf \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(here) # manage file paths\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nhere() starts at D:/RepTemplates/timeseries\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(socviz) # data and some useful things, especially %nin%\nlibrary(tidyverse) # your friend and mine\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.2     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.0     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.0\n✔ purrr     1.0.1     \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(scales) # Convenient scale labels\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'scales'\n\nThe following object is masked from 'package:purrr':\n\n    discard\n\nThe following object is masked from 'package:readr':\n\n    col_factor\n```\n\n\n:::\n\n```{.r .cell-code}\n# install.packages(\"tsibble\") # Time series objects\n# install.packages(\"feasts\") # Time series feature analysis\n# install.packages(\"slider\") # Moving averages and related methods\n#remotes::install_github(\"kjhealy/demog\") # Some US demographic data\nlibrary(tsibble)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'tsibble'\n\nThe following object is masked from 'package:lubridate':\n\n    interval\n\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, union\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(feasts)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: fabletools\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(slider)\nlibrary(demog)\n```\n:::\n\n\n\n## ATime Series: US Monthly Births\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboom <- okboomer |> \nfilter(country == \"United States\") |> \nselect(date, total_pop, births_pct_day) |> \nrename(births = births_pct_day)\nboom\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 996 × 3\n   date       total_pop births\n   <date>         <dbl>  <dbl>\n 1 1933-01-01 125579000   46.4\n 2 1933-02-01 125579000   47.2\n 3 1933-03-01 125579000   47.2\n 4 1933-04-01 125579000   45.5\n 5 1933-05-01 125579000   44.9\n 6 1933-06-01 125579000   44.9\n 7 1933-07-01 125579000   46.5\n 8 1933-08-01 125579000   46.7\n 9 1933-09-01 125579000   44.5\n10 1933-10-01 125579000   42.9\n# ℹ 986 more rows\n```\n\n\n:::\n:::\n\n\n\n## Looking at the Data\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboom |> \nggplot(mapping = aes(x = date,\ny = births)) +\ngeom_line()\n```\n\n::: {.cell-output-display}\n![](US_births_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n## smooth the data\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboom |> \nggplot(mapping = aes(x = date,\ny = births)) +\ngeom_line() + geom_smooth()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](US_births_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n## Centered Moving Averages: slider \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboom |> \nmutate(\nma3 = slide_dbl(births, mean,\n.before = 1, .after = 1,\n.complete = TRUE))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 996 × 4\n   date       total_pop births   ma3\n   <date>         <dbl>  <dbl> <dbl>\n 1 1933-01-01 125579000   46.4  NA  \n 2 1933-02-01 125579000   47.2  46.9\n 3 1933-03-01 125579000   47.2  46.6\n 4 1933-04-01 125579000   45.5  45.9\n 5 1933-05-01 125579000   44.9  45.1\n 6 1933-06-01 125579000   44.9  45.4\n 7 1933-07-01 125579000   46.5  46.0\n 8 1933-08-01 125579000   46.7  45.9\n 9 1933-09-01 125579000   44.5  44.7\n10 1933-10-01 125579000   42.9  43.8\n# ℹ 986 more rows\n```\n\n\n:::\n:::\n\n\n\n## Centered Moving Averages: slider \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboom |>\nmutate(\nma3 = slide_dbl(births, mean,\n.before = 1, .after = 1,\n.complete = TRUE)) |>\nggplot(aes(x = date, y = births)) +\ngeom_line() +\ngeom_line(aes(x = date, y = ma3), linewidth = rel(1.2), color = \"firebrick\") +\nlabs(title = \"MA Order 3 (1 month either side)\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 2 rows containing missing values or values outside the scale range\n(`geom_line()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](US_births_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n## Centered Moving Averages: Order 5\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboom |> \n mutate(\nma5 = slide_dbl(births, mean,\n.before = 2, .after = 2,\n.complete = TRUE)) |>\nggplot(aes(x = date, y = births)) +\ngeom_line() +\ngeom_line(aes(x = date, y = ma5), linewidth = rel(1.2), color = \"firebrick\") \n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 4 rows containing missing values or values outside the scale range\n(`geom_line()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](US_births_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n## Centered Moving Averages: Order 7\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboom |> \n mutate(\nma7 = slide_dbl(births, mean,\n.before = 3, .after = 3,\n.complete = TRUE)) |>\nggplot(aes(x = date, y = births)) +\ngeom_line() +\ngeom_line(aes(x = date, y = ma7), linewidth = rel(1.2), color = \"firebrick\") \n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 6 rows containing missing values or values outside the scale range\n(`geom_line()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](US_births_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n## Centered Moving Averages: Order 12\n\nIts calculated in two steps\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboom |> \nmutate(\nmav12 = slide_dbl(births, mean,\n.before = 5, .after = 6,\n.complete = TRUE),\nmav2x12 = slide_dbl(mav12, mean,\n.before = 1, .after = 0,\n.complete = TRUE))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 996 × 5\n   date       total_pop births mav12 mav2x12\n   <date>         <dbl>  <dbl> <dbl>   <dbl>\n 1 1933-01-01 125579000   46.4  NA      NA  \n 2 1933-02-01 125579000   47.2  NA      NA  \n 3 1933-03-01 125579000   47.2  NA      NA  \n 4 1933-04-01 125579000   45.5  NA      NA  \n 5 1933-05-01 125579000   44.9  NA      NA  \n 6 1933-06-01 125579000   44.9  45.4    NA  \n 7 1933-07-01 125579000   46.5  45.4    45.4\n 8 1933-08-01 125579000   46.7  45.4    45.4\n 9 1933-09-01 125579000   44.5  45.3    45.4\n10 1933-10-01 125579000   42.9  45.2    45.3\n# ℹ 986 more rows\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n  boom |> \nmutate(\nmav12 = slide_dbl(births, mean,\n.before = 5, .after = 6,\n.complete = TRUE),\nmav2x12 = slide_dbl(mav12, mean,\n.before = 1, .after = 0,\n.complete = TRUE)) |> \nggplot() +\ngeom_line(aes(x = date, y = births)) +\ngeom_line(aes(x = date, y = mav2x12), linewidth = rel(1.2), color = \"firebrick\") +\nlabs(title = \"12 month moving average\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 12 rows containing missing values or values outside the scale range\n(`geom_line()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](US_births_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n## 5 Year Moving Average\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboom |> \nmutate(\nmav12 = slide_dbl(births, mean,\n.before = 29, .after = 30,\n.complete = TRUE),\nmav2x12 = slide_dbl(mav12, mean,\n.before = 1, .after = 0,\n.complete = TRUE)) |> \nggplot() +\ngeom_line(aes(x = date, y = births)) +\ngeom_line(aes(x = date, y = mav2x12), linewidth = rel(1.2), color = \"firebrick\") +\nlabs(title = \"5 year moving average\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 60 rows containing missing values or values outside the scale range\n(`geom_line()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](US_births_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\nWider the window, smoother the line and we lose the details\n\n## Seasonal Decomposition\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Seasonality in US Birth Rates\nboom |> \nfilter(date > as.Date(\"1950-12-01\"),\ndate < as.Date(\"1957-01-01\")) |> \nggplot() +\ngeom_line(aes(x = date, y = births)) +\nscale_x_date(date_breaks = \"3 months\",\ndate_labels = \"%b\")\n```\n\n::: {.cell-output-display}\n![](US_births_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n\n## Calculate the Trend part\nThis is the moving average we just calculated.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboom_t <- boom |> \n  dplyr::select(date, births) |> \n  mutate(\n    month = lubridate::month(date),\n    mav12 = slide_dbl(births, mean, .before = 5, .after = 6, .complete = TRUE),\n    t = slide_dbl(mav12, mean, .before = 1, .after = 0, .complete = TRUE)\n  ) |> \n  dplyr::select(-mav12) # Don't need this anymore\n\nboom_t\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 996 × 4\n   date       births month     t\n   <date>      <dbl> <dbl> <dbl>\n 1 1933-01-01   46.4     1  NA  \n 2 1933-02-01   47.2     2  NA  \n 3 1933-03-01   47.2     3  NA  \n 4 1933-04-01   45.5     4  NA  \n 5 1933-05-01   44.9     5  NA  \n 6 1933-06-01   44.9     6  NA  \n 7 1933-07-01   46.5     7  45.4\n 8 1933-08-01   46.7     8  45.4\n 9 1933-09-01   44.5     9  45.4\n10 1933-10-01   42.9    10  45.3\n# ℹ 986 more rows\n```\n\n\n:::\n:::\n\n\n## Calculate the Seasonal part\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboom_t |> \nmutate(detrended = births - t)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 996 × 5\n   date       births month     t detrended\n   <date>      <dbl> <dbl> <dbl>     <dbl>\n 1 1933-01-01   46.4     1  NA      NA    \n 2 1933-02-01   47.2     2  NA      NA    \n 3 1933-03-01   47.2     3  NA      NA    \n 4 1933-04-01   45.5     4  NA      NA    \n 5 1933-05-01   44.9     5  NA      NA    \n 6 1933-06-01   44.9     6  NA      NA    \n 7 1933-07-01   46.5     7  45.4     1.04 \n 8 1933-08-01   46.7     8  45.4     1.29 \n 9 1933-09-01   44.5     9  45.4    -0.861\n10 1933-10-01   42.9    10  45.3    -2.34 \n# ℹ 986 more rows\n```\n\n\n:::\n:::\n\n\n## Calculate the Seasonal part\nThen take the average by month.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboom_t |> \nmutate(detrended = births - t,\nmonth = lubridate ::month(date)) |> \ngroup_by(month) |> \nsummarize(seasonal = mean(detrended, na.rm = TRUE))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 12 × 2\n   month seasonal\n   <dbl>    <dbl>\n 1     1   -1.62 \n 2     2   -0.578\n 3     3   -0.912\n 4     4   -2.21 \n 5     5   -1.99 \n 6     6   -0.333\n 7     7    1.90 \n 8     8    2.74 \n 9     9    3.39 \n10    10    0.765\n11    11   -0.564\n12    12   -0.625\n```\n\n\n:::\n:::\n\n\n\n\n## Mean centered Seasonal Part\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboom_t |> \nmutate(detrended = births - t) |> \ngroup_by(month) |> \nsummarize(sm = mean(detrended, na.rm = TRUE)) |> \nmutate(s = sm - mean(sm))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 12 × 3\n   month     sm      s\n   <dbl>  <dbl>  <dbl>\n 1     1 -1.62  -1.62 \n 2     2 -0.578 -0.575\n 3     3 -0.912 -0.909\n 4     4 -2.21  -2.21 \n 5     5 -1.99  -1.98 \n 6     6 -0.333 -0.330\n 7     7  1.90   1.90 \n 8     8  2.74   2.74 \n 9     9  3.39   3.40 \n10    10  0.765  0.768\n11    11 -0.564 -0.561\n12    12 -0.625 -0.622\n```\n\n\n:::\n:::\n\n\n\n## \nPut this in an object \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboom_s <-  boom_t |> \nmutate(detrended = births - t) |> \ngroup_by(month) |> \nsummarize(sm = mean(detrended, na.rm = TRUE)) |> \nmutate(s = sm - mean(sm)) |> \ndplyr::select(-sm) # don't need this anymore\nboom_s\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 12 × 2\n   month      s\n   <dbl>  <dbl>\n 1     1 -1.62 \n 2     2 -0.575\n 3     3 -0.909\n 4     4 -2.21 \n 5     5 -1.98 \n 6     6 -0.330\n 7     7  1.90 \n 8     8  2.74 \n 9     9  3.40 \n10    10  0.768\n11    11 -0.561\n12    12 -0.622\n```\n\n\n:::\n:::\n\n\n## Calculate the seasonal part\n\nJoin the trend and seasonal parts\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboom_ts <-  boom_t |> \nleft_join(boom_s, by = \"month\")\nboom_ts\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 996 × 5\n   date       births month     t      s\n   <date>      <dbl> <dbl> <dbl>  <dbl>\n 1 1933-01-01   46.4     1  NA   -1.62 \n 2 1933-02-01   47.2     2  NA   -0.575\n 3 1933-03-01   47.2     3  NA   -0.909\n 4 1933-04-01   45.5     4  NA   -2.21 \n 5 1933-05-01   44.9     5  NA   -1.98 \n 6 1933-06-01   44.9     6  NA   -0.330\n 7 1933-07-01   46.5     7  45.4  1.90 \n 8 1933-08-01   46.7     8  45.4  2.74 \n 9 1933-09-01   44.5     9  45.4  3.40 \n10 1933-10-01   42.9    10  45.3  0.768\n# ℹ 986 more rows\n```\n\n\n:::\n:::\n\n\n\n\n## Calculate the seasonal part\nIn `Classical` decomposition, the seasonal part is the average of the seasonal values for each month and it just repeats.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboom_ts |> \nggplot(aes(x = date, y = s)) +\ngeom_line()\n```\n\n::: {.cell-output-display}\n![](US_births_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n\n\n## Calculate the remainder part\n\nThe remainder is just what’s left over from y (i.e., births) after we have\ncalculated t and s.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboom_tsr <-  boom_ts |> \nmutate(r = births - t - s)\nboom_tsr\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 996 × 6\n   date       births month     t      s      r\n   <date>      <dbl> <dbl> <dbl>  <dbl>  <dbl>\n 1 1933-01-01   46.4     1  NA   -1.62  NA    \n 2 1933-02-01   47.2     2  NA   -0.575 NA    \n 3 1933-03-01   47.2     3  NA   -0.909 NA    \n 4 1933-04-01   45.5     4  NA   -2.21  NA    \n 5 1933-05-01   44.9     5  NA   -1.98  NA    \n 6 1933-06-01   44.9     6  NA   -0.330 NA    \n 7 1933-07-01   46.5     7  45.4  1.90  -0.863\n 8 1933-08-01   46.7     8  45.4  2.74  -1.46 \n 9 1933-09-01   44.5     9  45.4  3.40  -4.26 \n10 1933-10-01   42.9    10  45.3  0.768 -3.11 \n# ℹ 986 more rows\n```\n\n\n:::\n:::\n\n\n\n\n## There’s no need to it manually\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboom |> \nmutate(date = yearmonth(date)) |> \nas_tsibble(index = \"date\") |> \nmodel(\nclassical_decomposition(births,\ntype = \"additive\")\n) |> \ncomponents() |> \nselect(-.model)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tsibble: 996 x 6 [1M]\n       date births trend seasonal random season_adjust\n      <mth>  <dbl> <dbl>    <dbl>  <dbl>         <dbl>\n 1 1933 Jan   46.4  NA     -1.62  NA              48.0\n 2 1933 Feb   47.2  NA     -0.575 NA              47.8\n 3 1933 Mar   47.2  NA     -0.909 NA              48.1\n 4 1933 Apr   45.5  NA     -2.21  NA              47.7\n 5 1933 May   44.9  NA     -1.98  NA              46.9\n 6 1933 Jun   44.9  NA     -0.330 NA              45.3\n 7 1933 Jul   46.5  45.4    1.90  -0.863          44.6\n 8 1933 Aug   46.7  45.4    2.74  -1.46           44.0\n 9 1933 Sep   44.5  45.4    3.40  -4.26           41.1\n10 1933 Oct   42.9  45.3    0.768 -3.11           42.1\n# ℹ 986 more rows\n```\n\n\n:::\n:::\n\n\n\n\n## Plot the components\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboom |> \nmutate(date = yearmonth(date)) |> \nas_tsibble(index = \"date\") |> \nmodel(\nclassical_decomposition(births,\ntype = \"additive\")\n) |> \ncomponents() |> \n  autoplot()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 6 rows containing missing values or values outside the scale range\n(`geom_line()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](US_births_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "US_births_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}